<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USDT Faucet | Telegram Mini App</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        /* (CSS styles remain the same for brevity) */
        /* ... Önceki CSS kodunuz buraya gelmeli ... */
        :root {
            --bg-light: #ffffff;
            --bg-card: #f8f9fa;
            --color-primary: #007bff;
            --color-success: #28a745;
            --color-danger: #dc3545; 
            --color-warning: #ffc107; 
            --color-text-dark: #343a40;
            --color-text-light: #6c757d;
            --border-color: #dee2e6;
        }

        body { font-family: 'Roboto', sans-serif; background-color: var(--bg-light); color: var(--color-text-dark); margin: 0; padding: 0; }
        .container { padding: 20px; max-width: 800px; margin: 0 auto; }
        h2 { font-size: 1.8rem; color: var(--color-primary); border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-top: 25px; margin-bottom: 25px; }
        .card { background-color: var(--bg-card); padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); border: 1px solid var(--border-color); }
        .main-balance { text-align: center; padding: 30px 20px; }
        .balance-label { color: var(--color-text-light); font-weight: 500; }
        .balance-amount { font-size: 3.5rem; font-weight: 700; color: var(--color-primary); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .stat-value { font-size: 1.5rem; font-weight: 700; margin-top: 5px; }
        
        .shortlink-list-container { max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 0 10px; }

        .shortlink-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--border-color); }
        .shortlink-item:last-child { border-bottom: none; }
        .link-reward { font-weight: 700; color: var(--color-success); }
        .btn-visit, .btn-success { padding: 8px 15px; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; transition: opacity 0.2s; }
        .btn-visit { background-color: var(--color-primary); color: white; }
        .btn-success { background-color: var(--color-success); color: white; cursor: default; }
        .item-details { flex-grow: 1; }
        .item-details p { margin: 0; }
        .input-style { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; color: var(--color-text-dark); background-color: var(--bg-light); }
        .btn-primary { background-color: var(--color-primary); color: white; padding: 10px 20px; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background-color 0.2s; width: 100%; }
        .btn-primary:hover { background-color: #0056b3; }
        .disabled-item { opacity: 0.6; }
        
        .tab-nav { display: flex; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); overflow-x: auto; }
        .tab-nav button { flex-shrink: 0; background: none; border: none; padding: 10px 15px; cursor: pointer; font-size: 1rem; color: var(--color-text-light); border-bottom: 2px solid transparent; margin-right: 15px; font-weight: 500; }
        .tab-nav button.active { color: var(--color-primary); border-bottom: 2px solid var(--color-primary); font-weight: 700; }

        .header-content { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        #admin-icon-btn { color: var(--color-danger); font-size: 1.5rem; cursor: pointer; padding: 5px; display: none; background: none; border: none; }

        .scrollable-list-container { max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--bg-card); margin-top: 15px; }
        .admin-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border-color); }
        .admin-list-item:last-child { border-bottom: none; }
        .admin-tab-nav { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 15px; overflow-x: auto; }
        .admin-tab-nav button { flex-shrink: 0; background: none; border: none; padding: 10px 15px; cursor: pointer; font-size: 0.9rem; color: var(--color-text-light); border-bottom: 2px solid transparent; margin-right: 10px; font-weight: 500; }
        .admin-tab-nav button.active { color: var(--color-danger); border-bottom: 2px solid var(--color-danger); font-weight: 700; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 500; }
        .status-pending { background-color: var(--color-warning); color: var(--color-text-dark); }
        .status-paid { background-color: var(--color-success); color: white; }
        .status-rejected { background-color: var(--color-danger); color: white; }
    </style>
</head>
<body>

    <div class="container">
        
        <div class="header-content">
            <div></div> 
            <button id="admin-icon-btn" onclick="showSection('admin', this)">
                <i class="fas fa-cog"></i>
            </button>
        </div>
        
        <div class="card main-balance">
            <div class="balance-label">Total Balance (USD)</div>
            <div class="balance-amount" id="usd-balance">$0.00</div>
            <div style="font-size: 0.9rem; color: var(--color-text-light); margin-top: 5px;" id="crypto-value-label">~ 0.00000000 USDT</div>
        </div>

        <div class="tab-nav">
            <button class="active" onclick="showSection('dashboard', this)">Dashboard</button>
            <button onclick="showSection('shortlinks', this)">Shortlinks</button>
            <button onclick="showSection('withdraw', this)">Withdraw</button>
        </div>

        <div id="dashboard-section" class="section">
            <div class="stats-grid">
                <div class="card"><div class="balance-label">Total Referrals</div><div class="stat-value" style="color: var(--color-primary);" id="total-referrals">0</div></div>
                <div class="card"><div class="balance-label">Referral Earnings</div><div class="stat-value" style="color: var(--color-success);" id="referral-earnings">$0.00</div></div>
            </div>
            <div class="card">
                <h2><i class="fas fa-users"></i> Invite Friends</h2>
                <input type="text" id="referralLink" class="input-style" readonly value="Loading...">
                <button class="btn-primary" onclick="copyReferralLink()"><i class="fas fa-copy"></i> Copy Link</button>
            </div>
        </div>

        <div id="shortlinks-section" class="section" style="display:none;">
             <div class="card">
                <h2><i class="fas fa-link"></i> Available Shortlinks</h2>
                <p style="color: var(--color-text-light); font-size: 0.9rem;">Complete a shortlink to earn reward instantly.</p>
                <div class="shortlink-list-container">
                    <div id="shortlink-list"></div>
                </div>
            </div>
        </div>
        
        <div id="withdraw-section" class="section" style="display:none;">
             <div class="card">
                <h2><i class="fas fa-wallet"></i> Withdraw USDT (MATIC)</h2>
                <p style="color: var(--color-text-light);">Current Balance: <strong style="color: var(--color-success);" id="withdraw-usd-balance">$0.00</strong></p>
                <p style="font-size: 0.9rem; color: var(--color-danger); font-weight: 500;">Minimum Withdrawal: $0.50 USD</p>
                
                <label style="display: block; margin-top: 15px; font-weight: 500;">USDT (MATIC - Polygon) Address:</label>
                <input type="text" id="usdtAddress" placeholder="0x..." class="input-style">
                
                <label style="display: block; font-weight: 500;">Amount to Withdraw (USD):</label>
                <input type="number" id="withdrawAmount" value="0.50" class="input-style" min="0.50">

                <button class="btn-primary" onclick="requestWithdrawal()"><i class="fas fa-paper-plane"></i> Submit Withdrawal Request</button>
            </div>
        </div>

        <div id="admin-section" class="section" style="display:none;">
            <h2><i class="fas fa-tools"></i> Admin Panel</h2>
            
            <div class="admin-tab-nav">
                <button class="active" onclick="showAdminSection('admin-shortlinks-tab', this)">Create Link</button>
                <button onclick="showAdminSection('admin-withdrawals-tab', this)">Withdrawal Requests</button>
                <button onclick="showAdminSection('admin-users-tab', this)">User List</button>
            </div>
            
            <div id="admin-shortlinks-tab" class="admin-tab-content">
                <div class="card">
                    <h3>Create New Shortlink Callback</h3>
                    <p style="color: var(--color-text-light); font-size: 0.9rem; margin-bottom: 15px;">Enter the name and reward. Then use the generated Callback URL on your Shortlink Provider's website.</p>
                    <label>Link Name:</label>
                    <input type="text" id="linkName" class="input-style" placeholder="Daily Ad Link">
                    <label>Reward Amount (USD):</label>
                    <input type="number" id="rewardAmount" class="input-style" value="0.015" step="0.001">
                    <button class="btn-primary" onclick="addNewShortlink()"><i class="fas fa-plus"></i> Generate Callback URL</button>
                </div>

                <div id="callback-result-card" class="card" style="display:none; border-left: 5px solid #ffc107;">
                    <h3>✅ Link Created!</h3>
                    <p style="color:var(--color-text-light);">**CRITICAL:** Copy the URL below and paste it into your Shortlink platform's S2S Postback setting.</p>
                    <textarea id="finalCallbackUrlOutput" class="input-style" rows="4" readonly></textarea>
                    <label>Paste the Shortlink's **Base URL** here (e.g., https://shrtfly.com/xyz123)</label>
                    <input type="url" id="baseLinkUrlInput" class="input-style" placeholder="https://shrtfly.com/xyz123">
                    <button class="btn-primary" onclick="updateShortlinkBaseUrl()"><i class="fas fa-save"></i> Save Base URL to RTDB</button>
                </div>
            </div>

            <div id="admin-withdrawals-tab" class="admin-tab-content" style="display:none;">
                <h3 style="color: var(--color-danger);">Pending Withdrawal Requests</h3>
                <div class="scrollable-list-container" id="admin-withdrawal-list">
                     <div style="padding: 15px; color: var(--color-text-light);">Loading data...</div>
                </div>
            </div>

            <div id="admin-users-tab" class="admin-tab-content" style="display:none;">
                <h3>All Users (Sorted by Balance)</h3>
                <div class="scrollable-list-container" id="admin-user-list">
                     <div style="padding: 15px; color: var(--color-text-light);">Loading data...</div>
                </div>
            </div>
            
        </div>
        
    </div>

    <script>
        // =======================================================
        // CRITICAL CONFIGURATIONS (PLEASE CHANGE)
        // =======================================================
        const FIREBASE_API_KEY = 'AIzaSyCy1QPNWqd3nPnuECNRNNPtfNTOzq_0MxM'; 
        const RTDB_URL = 'https://shrtlinkearner-default-rtdb.firebaseio.com'; 
        const MIN_WITHDRAWAL = 0.50; 
        
        const BOT_NAME = 'ShrtLinkEarnerBot';
        
        // !!! CLOUD FUNCTION URLS (SADECE GEREKLİ OLANLAR KALDI) !!!
        const ADD_LINK_FUNCTION_URL = 'YOUR_ADD_LINK_FUNCTION_URL'; 
        const CALLBACK_BASE_URL = 'YOUR_FIREBASE_CALLBACK_URL'; 
        const WITHDRAW_FUNCTION_URL = 'YOUR_WITHDRAW_FUNCTION_URL'; 
        const UPDATE_BASE_URL_FUNCTION_URL = 'YOUR_UPDATE_BASE_URL_FUNCTION_URL'; 

        // !!! ADMIN TELEGRAM ID !!! (Kendi ID'nizle değiştirin)
        const ADMIN_IDS = ['7904032877']; 

        // =======================================================
        // GLOBAL STATE AND CORE FUNCTIONS
        // =======================================================
        let userId = '999999999'; 
        let userCompletedLinks = {};
        let shortlinksData = {};
        let currentUsdBalance = 0.00;
        let totalReferrals = 0;
        let referralEarnings = 0.00;
        let activeSection = 'dashboard';
        let activeAdminTab = 'admin-shortlinks-tab';
        let lastCreatedLinkId = null; 

        document.addEventListener('DOMContentLoaded', initializeMiniApp);

        function initializeMiniApp() {
            if (window.Telegram && window.Telegram.WebApp) {
                const webApp = window.Telegram.WebApp;
                webApp.ready();
                
                if (webApp.initDataUnsafe && webApp.initDataUnsafe.user && webApp.initDataUnsafe.user.id) {
                    userId = webApp.initDataUnsafe.user.id.toString(); 
                } 
                
                webApp.MainButton.setText("Refresh Balance").show().onClick(fetchData);
                document.body.style.backgroundColor = webApp.themeParams.bg_color || 'var(--bg-light)';
                
                if (ADMIN_IDS.includes(userId)) {
                    document.getElementById('admin-icon-btn').style.display = 'block';
                } else {
                    document.getElementById('admin-icon-btn').style.display = 'none';
                }
                
                fetchData(); 
                setInterval(fetchData, 10000); 
            } else {
                 fetchData();
            }
        }

        async function fetchData() {
            try {
                // 1. Kullanıcı Verisini Çekmeye Çalış
                const userReadResponse = await fetch(`${RTDB_URL}/users/${userId}.json?auth=${FIREBASE_API_KEY}`);
                let userData = await userReadResponse.json();
                
                // 2. Eğer Kullanıcı Verisi YOKSA veya okuma BAŞARISIZ OLURSA, Yeni Kayıt Oluşturmayı Dene
                if (!userReadResponse.ok || userData === null) {
                    console.log(`User ${userId} not found or read failed. Attempting to create new record.`);
                    
                    const initialData = {
                        balance: 0.00,
                        referrals: 0,
                        referral_earnings: 0.00,
                        completed_links: {},
                        join_date: Date.now()
                    };
                    
                    const userWriteResponse = await fetch(`${RTDB_URL}/users/${userId}.json?auth=${FIREBASE_API_KEY}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(initialData)
                    });

                    if (userWriteResponse.ok) {
                        userData = initialData; 
                        console.log(`User ${userId} successfully created.`);
                    } else {
                        console.error("CRITICAL: Failed to create user. Check RTDB Rules for /users/$uid write permission.");
                        window.Telegram.WebApp.showAlert("ERROR: Database connection failed. Please check RTDB Rules. (Write Access Denied)");
                        return; 
                    }
                }

                // 3. Verileri Yükle
                if (userData) {
                    currentUsdBalance = userData.balance || 0;
                    totalReferrals = userData.referrals || 0;
                    referralEarnings = userData.referral_earnings || 0;
                    userCompletedLinks = userData.completed_links || {}; 
                }

                // 4. Shortlinks Verisini Çek
                const linksResponse = await fetch(`${RTDB_URL}/shortlinks.json?auth=${FIREBASE_API_KEY}`);
                shortlinksData = await linksResponse.json();
                
                updateAllBalances();
                
                // Admin paneli açıksa, verileri çek.
                if (ADMIN_IDS.includes(userId) && activeSection === 'admin') {
                    // Bu sefer Cloud Function kullanmadan doğrudan RTDB'den çekiyoruz
                    fetchAdminData(activeAdminTab);
                }
            } catch (error) {
                console.error("General data fetching error:", error);
                window.Telegram.WebApp.showAlert("General Error: Could not connect to the database. Check API Key/RTDB URL.");
            }
        }

        function updateAllBalances() {
             document.getElementById('usd-balance').textContent = `$${currentUsdBalance.toFixed(4)}`;
             document.getElementById('crypto-value-label').textContent = `~ ${currentUsdBalance.toFixed(8)} USDT`;
             document.getElementById('total-referrals').textContent = totalReferrals;
             document.getElementById('referral-earnings').textContent = `$${referralEarnings.toFixed(4)}`;
             document.getElementById('referralLink').value = `https://t.me/${BOT_NAME}?start=${userId}`;
             document.getElementById('withdraw-usd-balance').textContent = `$${currentUsdBalance.toFixed(4)}`;
             
             if(activeSection === 'shortlinks') {
                 renderShortlinks();
             }
        }
        
        // ... (renderShortlinks, requestWithdrawal, addNewShortlink, updateShortlinkBaseUrl, copy functions aynı kalmıştır)

        // =======================================================
        // ADMIN PANEL FUNCTIONS (BASİTLEŞTİRİLDİ: Direkt RTDB Çekim)
        // =======================================================
        
        async function fetchAdminData(tabId) {
            if (!ADMIN_IDS.includes(userId) || tabId === 'admin-shortlinks-tab') return;

            const listEl = document.getElementById(tabId.replace('-tab', '-list'));
            if (!listEl) return;
            
            // Kullanıcı verisi çekiliyorsa 'users', çekim talebi çekiliyorsa 'withdrawals'
            const dataType = tabId === 'admin-withdrawals-tab' ? 'withdrawals' : 'users';
            
            listEl.innerHTML = `<div style="padding: 15px; color: var(--color-primary);"><i class="fas fa-spinner fa-spin"></i> Loading data...</div>`;

            try {
                // Admin yetkisiyle doğrudan RTDB'den veri çekme (Rules'ta Admin ID'ye izin verilmeli!)
                const response = await fetch(`${RTDB_URL}/${dataType}.json?auth=${FIREBASE_API_KEY}`);
                
                if (!response.ok) {
                     // Hata kodu 401 veya 403 ise RTDB Rules'dan geliyor
                     throw new Error(`RTDB Access Denied! Status: ${response.status}. Check Admin Rules for /${dataType}.`);
                }

                const data = await response.json();
                
                if (dataType === 'withdrawals') {
                    renderWithdrawals(data);
                } else if (dataType === 'users') {
                    renderUsers(data);
                }
                
            } catch (e) {
                let errorMessage = e.message.includes("RTDB Access Denied") 
                    ? `Admin verisi yüklenemedi. Kural hatası: /${dataType} için OKUMA iznini kontrol edin.` 
                    : `Veritabanı bağlantı hatası: ${e.message}`;
                    
                listEl.innerHTML = `<div style="padding: 15px; color: var(--color-danger);">
                                     <i class="fas fa-exclamation-triangle"></i> ${errorMessage}
                                   </div>`;
            }
        }

        // ... (renderWithdrawals, renderUsers fonksiyonları aynı kalmıştır)
        
        function renderWithdrawals(withdrawals) {
            const listEl = document.getElementById('admin-withdrawal-list');
            listEl.innerHTML = '';
            
            if (!withdrawals || Object.keys(withdrawals).length === 0) {
                 listEl.innerHTML = `<div style="padding: 15px; color: var(--color-text-light);">No pending or completed withdrawal requests found.</div>`;
                 return;
            }
            
            Object.entries(withdrawals).forEach(([id, item]) => {
                const statusClass = item.status === 'Paid' ? 'status-paid' : item.status === 'Rejected' ? 'status-rejected' : 'status-pending';
                const itemHtml = `
                    <div class="admin-list-item">
                        <div>
                            <span style="font-weight: 500; color: ${item.status === 'Pending' ? 'var(--color-danger)' : 'var(--color-text-dark)'};">$${(item.amount || 0).toFixed(2)} USD</span>
                            <p style="font-size: 0.8rem; color: var(--color-text-light); margin: 2px 0;">UID: ${item.uid} | Adr: ${item.address ? item.address.substring(0, 8) + '...' : 'N/A'}</p>
                        </div>
                        <span class="status-badge ${statusClass}">${item.status}</span>
                    </div>
                `;
                listEl.innerHTML += itemHtml;
            });
        }
        
        function renderUsers(users) {
             const listEl = document.getElementById('admin-user-list');
             listEl.innerHTML = '';
             
             if (!users || Object.keys(users).length === 0) {
                 listEl.innerHTML = `<div style="padding: 15px; color: var(--color-text-light);">No registered users found.</div>`;
                 return;
             }

             const sortedUsers = Object.entries(users).sort(([, a], [, b]) => (b.balance || 0) - (a.balance || 0));

             sortedUsers.forEach(([uid, user]) => {
                 const itemHtml = `
                     <div class="admin-list-item">
                         <div>
                             <span style="font-weight: 500;">UID: ${uid}</span>
                             <p style="font-size: 0.8rem; color: var(--color-text-light); margin: 2px 0;">Balance: $${(user.balance || 0).toFixed(4)} | Refs: ${user.referrals || 0}</p>
                         </div>
                         <span style="font-size: 0.9rem; color: var(--color-primary);">${(user.balance || 0) >= MIN_WITHDRAWAL ? 'Ready to Withdraw' : 'Insufficient'}</span>
                     </div>
                 `;
                 listEl.innerHTML += itemHtml;
             });
        }
        
        // ... (Kalan fonksiyonlar aynı kalmıştır)
        
        function showAdminSection(tabId, element) {
            activeAdminTab = tabId;
            document.querySelectorAll('.admin-tab-content').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(tabId).style.display = 'block';

            document.querySelectorAll('.admin-tab-nav button').forEach(button => {
                button.classList.remove('active');
            });
            element.classList.add('active');
            
            // Yeni kodda, doğrudan RTDB'den çekim yapılır
            fetchAdminData(tabId);
        }
        
        // ... (Tüm diğer fonksiyonlar buraya eklenmeli)
    </script>
</body>
</html>
