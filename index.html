<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USDT Faucet | Telegram Mini App</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        /* (CSS styles remain the same for brevity) */
        :root {
            --bg-light: #ffffff;
            --bg-card: #f8f9fa;
            --color-primary: #007bff;
            --color-success: #28a745;
            --color-danger: #dc3545; 
            --color-warning: #ffc107; 
            --color-text-dark: #343a40;
            --color-text-light: #6c757d;
            --border-color: #dee2e6;
        }

        body { font-family: 'Roboto', sans-serif; background-color: var(--bg-light); color: var(--color-text-dark); margin: 0; padding: 0; }
        .container { padding: 20px; max-width: 800px; margin: 0 auto; }
        h2 { font-size: 1.8rem; color: var(--color-primary); border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-top: 25px; margin-bottom: 25px; }
        .card { background-color: var(--bg-card); padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); border: 1px solid var(--border-color); }
        .main-balance { text-align: center; padding: 30px 20px; }
        .balance-label { color: var(--color-text-light); font-weight: 500; }
        .balance-amount { font-size: 3.5rem; font-weight: 700; color: var(--color-primary); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .stat-value { font-size: 1.5rem; font-weight: 700; margin-top: 5px; }
        
        .shortlink-list-container { max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 0 10px; }

        .shortlink-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--border-color); }
        .shortlink-item:last-child { border-bottom: none; }
        .link-reward { font-weight: 700; color: var(--color-success); }
        .btn-visit, .btn-success { padding: 8px 15px; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; transition: opacity 0.2s; }
        .btn-visit { background-color: var(--color-primary); color: white; }
        .btn-success { background-color: var(--color-success); color: white; cursor: default; }
        .item-details { flex-grow: 1; }
        .item-details p { margin: 0; }
        .input-style { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; color: var(--color-text-dark); background-color: var(--bg-light); }
        .btn-primary { background-color: var(--color-primary); color: white; padding: 10px 20px; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background-color 0.2s; width: 100%; }
        .btn-primary:hover { background-color: #0056b3; }
        .disabled-item { opacity: 0.6; }
        
        .tab-nav { display: flex; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); overflow-x: auto; }
        .tab-nav button { flex-shrink: 0; background: none; border: none; padding: 10px 15px; cursor: pointer; font-size: 1rem; color: var(--color-text-light); border-bottom: 2px solid transparent; margin-right: 15px; font-weight: 500; }
        .tab-nav button.active { color: var(--color-primary); border-bottom: 2px solid var(--color-primary); font-weight: 700; }

        .header-content { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        #admin-icon-btn { color: var(--color-danger); font-size: 1.5rem; cursor: pointer; padding: 5px; display: none; background: none; border: none; }

        .scrollable-list-container { max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--bg-card); margin-top: 15px; }
        .admin-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border-color); }
        .admin-list-item:last-child { border-bottom: none; }
        .admin-tab-nav { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 15px; overflow-x: auto; }
        .admin-tab-nav button { flex-shrink: 0; background: none; border: none; padding: 10px 15px; cursor: pointer; font-size: 0.9rem; color: var(--color-text-light); border-bottom: 2px solid transparent; margin-right: 10px; font-weight: 500; }
        .admin-tab-nav button.active { color: var(--color-danger); border-bottom: 2px solid var(--color-danger); font-weight: 700; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 500; }
        .status-pending { background-color: var(--color-warning); color: var(--color-text-dark); }
        .status-paid { background-color: var(--color-success); color: white; }
        .status-rejected { background-color: var(--color-danger); color: white; }

    </style>
</head>
<body>

    <div class="container">
        
        <div class="header-content">
            <div></div> 
            <button id="admin-icon-btn" onclick="showSection('admin', this)">
                <i class="fas fa-cog"></i>
            </button>
        </div>
        
        <div class="card main-balance">
            <div class="balance-label">Total Balance (USD)</div>
            <div class="balance-amount" id="usd-balance">$0.00</div>
            <div style="font-size: 0.9rem; color: var(--color-text-light); margin-top: 5px;" id="crypto-value-label">~ 0.00000000 USDT</div>
        </div>

        <div class="tab-nav">
            <button class="active" onclick="showSection('dashboard', this)">Dashboard</button>
            <button onclick="showSection('shortlinks', this)">Shortlinks</button>
            <button onclick="showSection('withdraw', this)">Withdraw</button>
        </div>

        <div id="dashboard-section" class="section">
            <div class="stats-grid">
                <div class="card"><div class="balance-label">Total Referrals</div><div class="stat-value" style="color: var(--color-primary);" id="total-referrals">0</div></div>
                <div class="card"><div class="balance-label">Referral Earnings</div><div class="stat-value" style="color: var(--color-success);" id="referral-earnings">$0.00</div></div>
            </div>
            <div class="card">
                <h2><i class="fas fa-users"></i> Invite Friends</h2>
                <input type="text" id="referralLink" class="input-style" readonly value="Loading...">
                <button class="btn-primary" onclick="copyReferralLink()"><i class="fas fa-copy"></i> Copy Link</button>
            </div>
        </div>

        <div id="shortlinks-section" class="section" style="display:none;">
             <div class="card">
                <h2><i class="fas fa-link"></i> Available Shortlinks</h2>
                <p style="color: var(--color-text-light); font-size: 0.9rem;">Complete a shortlink to earn reward instantly.</p>
                <div class="shortlink-list-container">
                    <div id="shortlink-list"></div>
                </div>
            </div>
        </div>
        
        <div id="withdraw-section" class="section" style="display:none;">
             <div class="card">
                <h2><i class="fas fa-wallet"></i> Withdraw USDT (MATIC)</h2>
                <p style="color: var(--color-text-light);">Current Balance: <strong style="color: var(--color-success);" id="withdraw-usd-balance">$0.00</strong></p>
                <p style="font-size: 0.9rem; color: var(--color-danger); font-weight: 500;">Minimum Withdrawal: $0.50 USD</p>
                
                <label style="display: block; margin-top: 15px; font-weight: 500;">USDT (MATIC - Polygon) Address:</label>
                <input type="text" id="usdtAddress" placeholder="0x..." class="input-style">
                
                <label style="display: block; font-weight: 500;">Amount to Withdraw (USD):</label>
                <input type="number" id="withdrawAmount" value="0.50" class="input-style" min="0.50">

                <button class="btn-primary" onclick="requestWithdrawal()"><i class="fas fa-paper-plane"></i> Submit Withdrawal Request</button>
            </div>
        </div>

        <div id="admin-section" class="section" style="display:none;">
            <h2><i class="fas fa-tools"></i> Admin Panel</h2>
            
            <div class="admin-tab-nav">
                <button class="active" onclick="showAdminSection('admin-shortlinks-tab', this)">Create Link</button>
                <button onclick="showAdminSection('admin-withdrawals-tab', this)">Withdrawal Requests</button>
                <button onclick="showAdminSection('admin-users-tab', this)">User List</button>
            </div>
            
            <div id="admin-shortlinks-tab" class="admin-tab-content">
                <div class="card">
                    <h3>Create New Shortlink Callback</h3>
                    <p style="color: var(--color-text-light); font-size: 0.9rem; margin-bottom: 15px;">Enter the name and reward. Then use the generated Callback URL on your Shortlink Provider's website.</p>
                    <label>Link Name:</label>
                    <input type="text" id="linkName" class="input-style" placeholder="Daily Ad Link">
                    <label>Reward Amount (USD):</label>
                    <input type="number" id="rewardAmount" class="input-style" value="0.015" step="0.001">
                    <button class="btn-primary" onclick="addNewShortlink()"><i class="fas fa-plus"></i> Generate Callback URL</button>
                </div>

                <div id="callback-result-card" class="card" style="display:none; border-left: 5px solid #ffc107;">
                    <h3>✅ Link Created!</h3>
                    <p style="color:var(--color-text-light);">**CRITICAL:** Copy the URL below and paste it into your Shortlink platform's S2S Postback setting.</p>
                    <textarea id="finalCallbackUrlOutput" class="input-style" rows="4" readonly></textarea>
                    <label>Paste the Shortlink's **Base URL** here (e.g., https://shrtfly.com/xyz123)</label>
                    <input type="url" id="baseLinkUrlInput" class="input-style" placeholder="https://shrtfly.com/xyz123">
                    <button class="btn-primary" onclick="updateShortlinkBaseUrl()"><i class="fas fa-save"></i> Save Base URL to RTDB</button>
                </div>
            </div>

            <div id="admin-withdrawals-tab" class="admin-tab-content" style="display:none;">
                <h3 style="color: var(--color-danger);">Pending Withdrawal Requests</h3>
                <div class="scrollable-list-container" id="admin-withdrawal-list">
                     <div style="padding: 15px; color: var(--color-text-light);">Loading data...</div>
                </div>
            </div>

            <div id="admin-users-tab" class="admin-tab-content" style="display:none;">
                <h3>All Users (Sorted by Balance)</h3>
                <div class="scrollable-list-container" id="admin-user-list">
                     <div style="padding: 15px; color: var(--color-text-light);">Loading data...</div>
                </div>
            </div>
            
        </div>
        
    </div>

    <script>
        // =======================================================
        // CRITICAL CONFIGURATIONS (PLEASE CHANGE)
        // =======================================================
        const FIREBASE_API_KEY = 'AIzaSyCy1QPNWqd3nPnuECNRNNPtfNTOzq_0MxM'; 
        const RTDB_URL = 'https://shrtlinkearner-default-rtdb.firebaseio.com'; 
        const MIN_WITHDRAWAL = 0.50; 
        
        const BOT_NAME = 'ShrtLinkEarnerBot';
        
        // !!! REAL CLOUD FUNCTION URLS (MUST BE DEPLOYED) !!!
        const ADD_LINK_FUNCTION_URL = 'YOUR_ADD_LINK_FUNCTION_URL'; 
        const CALLBACK_BASE_URL = 'YOUR_FIREBASE_CALLBACK_URL'; 
        const WITHDRAW_FUNCTION_URL = 'YOUR_WITHDRAW_FUNCTION_URL'; 
        const ADMIN_GET_DATA_FUNCTION_URL = 'YOUR_ADMIN_GET_DATA_FUNCTION_URL'; 
        const UPDATE_BASE_URL_FUNCTION_URL = 'YOUR_UPDATE_BASE_URL_FUNCTION_URL'; 

        // !!! ADMIN TELEGRAM ID !!!
        const ADMIN_IDS = ['7904032877']; 

        // =======================================================
        // GLOBAL STATE AND CORE FUNCTIONS
        // =======================================================
        let userId = '999999999'; 
        let userCompletedLinks = {};
        let shortlinksData = {};
        let currentUsdBalance = 0.00;
        let totalReferrals = 0;
        let referralEarnings = 0.00;
        let activeSection = 'dashboard';
        let activeAdminTab = 'admin-shortlinks-tab';
        let lastCreatedLinkId = null; 

        document.addEventListener('DOMContentLoaded', initializeMiniApp);

        function initializeMiniApp() {
            if (window.Telegram && window.Telegram.WebApp) {
                const webApp = window.Telegram.WebApp;
                webApp.ready();
                
                if (webApp.initDataUnsafe && webApp.initDataUnsafe.user && webApp.initDataUnsafe.user.id) {
                    userId = webApp.initDataUnsafe.user.id.toString(); 
                } 
                
                webApp.MainButton.setText("Refresh Balance").show().onClick(fetchData);
                document.body.style.backgroundColor = webApp.themeParams.bg_color || 'var(--bg-light)';
                
                if (ADMIN_IDS.includes(userId)) {
                    document.getElementById('admin-icon-btn').style.display = 'block';
                } else {
                    document.getElementById('admin-icon-btn').style.display = 'none';
                }
                
                fetchData(); 
                setInterval(fetchData, 10000); 
            } else {
                 fetchData();
            }
        }

        async function fetchData() {
            try {
                // 1. Fetch User Data
                const userResponse = await fetch(`${RTDB_URL}/users/${userId}.json?auth=${FIREBASE_API_KEY}`);
                let userData = await userResponse.json();

                // 2. Yeni Kayıt Oluştur
                if (!userData) {
                    console.log(`User ${userId} not found. Creating new record.`);
                    const initialData = {
                        balance: 0.00,
                        referrals: 0,
                        referral_earnings: 0.00,
                        completed_links: {},
                        join_date: Date.now()
                    };
                    
                    await fetch(`${RTDB_URL}/users/${userId}.json?auth=${FIREBASE_API_KEY}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(initialData)
                    });
                    
                    userData = initialData; 
                }

                // 3. Verileri Yükle
                if (userData) {
                    currentUsdBalance = userData.balance || 0;
                    totalReferrals = userData.referrals || 0;
                    referralEarnings = userData.referral_earnings || 0;
                    userCompletedLinks = userData.completed_links || {}; 
                }

                // 4. Fetch Shortlinks Data
                const linksResponse = await fetch(`${RTDB_URL}/shortlinks.json?auth=${FIREBASE_API_KEY}`);
                shortlinksData = await linksResponse.json();
                
                updateAllBalances();
                
                if (ADMIN_IDS.includes(userId) && activeSection === 'admin') {
                    fetchAdminData(activeAdminTab);
                }
            } catch (error) {
                console.error("Data fetching or user creation error:", error);
                // Mini App'in yüklenmesini engellemeyelim
            }
        }

        function updateAllBalances() {
             document.getElementById('usd-balance').textContent = `$${currentUsdBalance.toFixed(4)}`;
             document.getElementById('crypto-value-label').textContent = `~ ${currentUsdBalance.toFixed(8)} USDT`;
             document.getElementById('total-referrals').textContent = totalReferrals;
             document.getElementById('referral-earnings').textContent = `$${referralEarnings.toFixed(4)}`;
             document.getElementById('referralLink').value = `https://t.me/${BOT_NAME}?start=${userId}`;
             document.getElementById('withdraw-usd-balance').textContent = `$${currentUsdBalance.toFixed(4)}`;
             
             if(activeSection === 'shortlinks') {
                 renderShortlinks();
             }
        }
        
        // ... (renderShortlinks ve diğer fonksiyonlar aynı kalmıştır)

        // =======================================================
        // ADMIN PANEL FUNCTIONS (GÜNCELLENDİ)
        // =======================================================
        
        async function fetchAdminData(tabId) {
            if (!ADMIN_IDS.includes(userId) || tabId === 'admin-shortlinks-tab') return;

            const listEl = document.getElementById(tabId.replace('-tab', '-list'));
            if (!listEl) return;
            
            listEl.innerHTML = `<div style="padding: 15px; color: var(--color-primary);"><i class="fas fa-spinner fa-spin"></i> Loading data...</div>`;

            const dataType = tabId === 'admin-withdrawals-tab' ? 'withdrawals' : 'users';
            
            try {
                // Deneme 1: Cloud Function (Güvenli Yol)
                const response = await fetch(ADMIN_GET_DATA_FUNCTION_URL, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: { dataType: dataType, adminId: userId } }) 
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const data = result.data?.list || {}; 

                    if (dataType === 'withdrawals') {
                        renderWithdrawals(data);
                    } else if (dataType === 'users') {
                        renderUsers(data);
                    }
                    return; // Başarılı, fonksiyonu bitir
                } else {
                    // Cloud Function'dan hata gelirse logla ve devam et
                    console.error(`Cloud Function Error (${dataType}):`, response.statusText);
                }

            } catch (e) {
                console.warn(`Cloud Function connection failed. Trying direct RTDB access for debug. Error: ${e.message}`);
                // Muhtemelen yanlış URL veya CORS hatası
            }

            // Deneme 2: Direkt RTDB Okuma (Sadece Admin için ve test amaçlı)
            try {
                const directResponse = await fetch(`${RTDB_URL}/${dataType}.json?auth=${FIREBASE_API_KEY}`);
                
                if (!directResponse.ok) throw new Error("RTDB Access Denied (Check Firebase Rules)");

                const directData = await directResponse.json();
                
                if (dataType === 'withdrawals') {
                    renderWithdrawals(directData);
                } else if (dataType === 'users') {
                    renderUsers(directData);
                }
                
                // Başarılı olursa, kullanıcıya uyarı göster (güvenlik uyarısı)
                console.warn("RTDB Direct access successful! Please ensure your Cloud Function is working for security.");
            } catch (e) {
                // Her iki yöntem de başarısız olursa hata mesajı göster
                let errorMessage = e.message.includes("RTDB Access Denied") 
                    ? "RTDB'den doğrudan erişim engellendi. Firebase Rules'ı kontrol edin!" 
                    : "Admin verisi yüklenemedi. Cloud Function URL'sini veya loglarını kontrol edin.";
                    
                listEl.innerHTML = `<div style="padding: 15px; color: var(--color-danger);">
                                     <i class="fas fa-exclamation-triangle"></i> ${errorMessage}
                                   </div>`;
            }
        }

        // ... (renderWithdrawals, renderUsers ve diğer fonksiyonlar aynı kalmıştır)
        
        // =======================================================
        // KODUN KALAN KISMI AYNI KALMIŞTIR
        // =======================================================
        
        function renderShortlinks() { 
            const listEl = document.getElementById('shortlink-list');
            listEl.innerHTML = '';
            
            if (!shortlinksData || Object.keys(shortlinksData).length === 0) {
                 listEl.innerHTML = `<div style="padding: 15px; color: var(--color-text-light);">No active shortlinks found.</div>`;
                 return;
            }

            const currentTime = Date.now();
            const twentyFourHours = 86400000; 
            
            Object.entries(shortlinksData).forEach(([linkId, linkData]) => {
                if (!linkData.base_url) return; 

                const lastCompletedTime = userCompletedLinks[linkId] || 0;
                const isReady = (currentTime - lastCompletedTime) > twentyFourHours; 
                
                const finalVisitUrl = `${linkData.base_url}?sub_id=${userId}`; 

                const itemHtml = `
                    <div class="shortlink-item ${!isReady ? 'disabled-item' : ''}">
                        <div class="item-details">
                            <p style="font-weight: 500;">${linkData.name}</p>
                            <p style="font-size: 0.8rem; color: var(--color-text-light);">
                                Reward: <strong style="color: var(--color-success);">$${linkData.reward.toFixed(4)} USDT</strong>
                            </p>
                        </div>
                        <div style="margin-left: 15px;">
                            ${!isReady 
                                ? `<button class="btn-success" disabled>
                                     <i class="fas fa-history"></i> Cooldown
                                   </button>`
                                : `<a href="${finalVisitUrl}" target="_blank" class="btn-visit" onclick="closeMiniAppOnVisit();">
                                     <i class="fas fa-external-link-alt"></i> Visit Link
                                   </a>`
                            }
                        </div>
                    </div>
                `;
                listEl.innerHTML += itemHtml;
            });

             if (listEl.innerHTML === '') {
                 listEl.innerHTML = `<div style="padding: 15px; color: var(--color-text-light);">All links completed or no links available.</div>`;
             }
        }

        function closeMiniAppOnVisit() {
             if (window.Telegram && window.Telegram.WebApp) {
                 window.Telegram.WebApp.close();
             }
        }

        async function requestWithdrawal() {
             const amount = parseFloat(document.getElementById('withdrawAmount').value);
             const address = document.getElementById('usdtAddress').value.trim();
             
             if(amount < MIN_WITHDRAWAL) { window.Telegram.WebApp.showAlert(`Minimum withdrawal is $${MIN_WITHDRAWAL.toFixed(2)} USD.`); return; }
             if(amount > currentUsdBalance) { window.Telegram.WebApp.showAlert("Insufficient balance!"); return; }
             if(address.length < 20 || !address.startsWith('0x')) { window.Telegram.WebApp.showAlert("Invalid USDT (MATIC) address!"); return; }
             
             window.Telegram.WebApp.MainButton.setText("Submitting Request...").show().disable();
             
             try {
                const response = await fetch(WITHDRAW_FUNCTION_URL, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: { userId: userId, amount: amount, address: address, currency: 'USDT_MATIC' } })
                });
                
                const result = await response.json();
                
                if (result.data && result.data.status === 'success') {
                    window.Telegram.WebApp.showAlert("Your withdrawal request has been successfully created and is pending processing.");
                    fetchData(); 
                } else {
                    window.Telegram.WebApp.showAlert(`Error: ${result.error?.message || 'Withdrawal request denied by server.'}`);
                }
             } catch (e) {
                 window.Telegram.WebApp.showAlert("Failed to send withdrawal request. Server connection error. Check WITHDRAW_FUNCTION_URL.");
             } finally {
                window.Telegram.WebApp.MainButton.setText("Refresh Balance").enable();
             }
        }

        async function addNewShortlink() {
            if (!ADMIN_IDS.includes(userId)) { window.Telegram.WebApp.showAlert("Unauthorized operation!"); return; }
            const name = document.getElementById('linkName').value;
            const reward = document.getElementById('rewardAmount').value;

            if (!name || isNaN(parseFloat(reward)) || parseFloat(reward) <= 0) { window.Telegram.WebApp.showAlert("Please fill in Link Name and valid Reward Amount."); return; }
            
            document.getElementById('callback-result-card').style.display = 'none';
            window.Telegram.WebApp.MainButton.setText("Generating Callback...").show().disable();

            try {
                const dataToSend = { name: name, reward: reward, callback_base_url: CALLBACK_BASE_URL, adminId: userId };
                const response = await fetch(ADD_LINK_FUNCTION_URL, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: dataToSend }) 
                });
                const result = await response.json();
                
                if (result.data && result.data.status === 'success') {
                    lastCreatedLinkId = result.data.linkId; 
                    document.getElementById('finalCallbackUrlOutput').value = result.data.finalCallbackUrl;
                    document.getElementById('callback-result-card').style.display = 'block';
                    window.Telegram.WebApp.showAlert(`Callback URL successfully generated! Now enter the Base URL.`);
                } else {
                    window.Telegram.WebApp.showAlert(`Error: ${result.error?.message || 'Server error while generating link.'}`);
                }
            } catch (error) {
                window.Telegram.WebApp.showAlert("Could not connect to server. Check ADD_LINK_FUNCTION_URL.");
            } finally {
                window.Telegram.WebApp.MainButton.setText("Refresh Balance").enable();
            }
        }

        async function updateShortlinkBaseUrl() {
            if (!ADMIN_IDS.includes(userId) || !lastCreatedLinkId) { window.Telegram.WebApp.showAlert("Unauthorized or no Link ID created yet!"); return; }

            const baseUrl = document.getElementById('baseLinkUrlInput').value.trim();

            if (!baseUrl || !baseUrl.startsWith('http')) { 
                window.Telegram.WebApp.showAlert("Please enter a valid Shortlink Base URL."); 
                return;
            }

            window.Telegram.WebApp.MainButton.setText("Saving Base URL...").show().disable();

            try {
                const dataToSend = { linkId: lastCreatedLinkId, baseUrl: baseUrl, adminId: userId };
                const response = await fetch(UPDATE_BASE_URL_FUNCTION_URL, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: dataToSend }) 
                });
                const result = await response.json();

                if (result.data && result.data.status === 'success') {
                    window.Telegram.WebApp.showAlert(`Base URL successfully saved for Link ID: ${lastCreatedLinkId}. Link is now active!`);
                    document.getElementById('callback-result-card').style.display = 'none';
                    lastCreatedLinkId = null; 
                    fetchData(); 
                } else {
                    window.Telegram.WebApp.showAlert(`Error: ${result.error?.message || 'Server error while saving Base URL.'}`);
                }
            } catch (error) {
                window.Telegram.WebApp.showAlert("Could not connect to server. Check UPDATE_BASE_URL_FUNCTION_URL.");
            } finally {
                window.Telegram.WebApp.MainButton.setText("Refresh Balance").enable();
            }
        }
        
        function copyCallbackUrl() {
            const textarea = document.getElementById('finalCallbackUrlOutput');
            textarea.select();
            textarea.setSelectionRange(0, 99999); 
            navigator.clipboard.writeText(textarea.value);
            window.Telegram.WebApp.showAlert("Callback URL copied to clipboard!");
        }

        function copyReferralLink() {
            const linkInput = document.getElementById('referralLink');
            linkInput.select();
            linkInput.setSelectionRange(0, 99999); 
            navigator.clipboard.writeText(linkInput.value);
            window.Telegram.WebApp.showPopup({message: 'Referral link copied to clipboard!'});
        }
        
        function showAdminSection(tabId, element) {
            activeAdminTab = tabId;
            document.querySelectorAll('.admin-tab-content').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(tabId).style.display = 'block';

            document.querySelectorAll('.admin-tab-nav button').forEach(button => {
                button.classList.remove('active');
            });
            element.classList.add('active');
            
            fetchAdminData(tabId);
        }
        
        function renderWithdrawals(withdrawals) {
            const listEl = document.getElementById('admin-withdrawal-list');
            listEl.innerHTML = '';
            
            if (!withdrawals || Object.keys(withdrawals).length === 0) {
                 listEl.innerHTML = `<div style="padding: 15px; color: var(--color-text-light);">No pending or completed withdrawal requests found.</div>`;
                 return;
            }
            
            Object.entries(withdrawals).forEach(([id, item]) => {
                const statusClass = item.status === 'Paid' ? 'status-paid' : item.status === 'Rejected' ? 'status-rejected' : 'status-pending';
                const itemHtml = `
                    <div class="admin-list-item">
                        <div>
                            <span style="font-weight: 500; color: ${item.status === 'Pending' ? 'var(--color-danger)' : 'var(--color-text-dark)'};">$${(item.amount || 0).toFixed(2)} USD</span>
                            <p style="font-size: 0.8rem; color: var(--color-text-light); margin: 2px 0;">UID: ${item.uid} | Adr: ${item.address ? item.address.substring(0, 8) + '...' : 'N/A'}</p>
                        </div>
                        <span class="status-badge ${statusClass}">${item.status}</span>
                    </div>
                `;
                listEl.innerHTML += itemHtml;
            });
        }
        
        function renderUsers(users) {
             const listEl = document.getElementById('admin-user-list');
             listEl.innerHTML = '';
             
             if (!users || Object.keys(users).length === 0) {
                 listEl.innerHTML = `<div style="padding: 15px; color: var(--color-text-light);">No registered users found.</div>`;
                 return;
             }

             const sortedUsers = Object.entries(users).sort(([, a], [, b]) => (b.balance || 0) - (a.balance || 0));

             sortedUsers.forEach(([uid, user]) => {
                 const itemHtml = `
                     <div class="admin-list-item">
                         <div>
                             <span style="font-weight: 500;">UID: ${uid}</span>
                             <p style="font-size: 0.8rem; color: var(--color-text-light); margin: 2px 0;">Balance: $${(user.balance || 0).toFixed(4)} | Refs: ${user.referrals || 0}</p>
                         </div>
                         <span style="font-size: 0.9rem; color: var(--color-primary);">${(user.balance || 0) >= MIN_WITHDRAWAL ? 'Ready to Withdraw' : 'Insufficient'}</span>
                     </div>
                 `;
                 listEl.innerHTML += itemHtml;
             });
        }

        function showSection(sectionId, element) {
            activeSection = sectionId;
            document.querySelectorAll('.section').forEach(section => { section.style.display = 'none'; });
            document.getElementById(`${sectionId}-section`).style.display = 'block';
            
            document.querySelectorAll('.tab-nav button').forEach(button => { button.classList.remove('active'); });
            
            if (element && element.tagName === 'BUTTON' && element.parentElement.classList.contains('tab-nav')) {
                element.classList.add('active');
            } else if (sectionId === 'dashboard') {
                 document.querySelector('.tab-nav button').classList.add('active');
            }
            
            if (sectionId === 'shortlinks') { renderShortlinks(); } 
            else if (sectionId === 'admin' && ADMIN_IDS.includes(userId)) {
                 const defaultTabButton = document.querySelector('.admin-tab-nav button.active');
                 if (defaultTabButton) {
                     const tabIdMatch = defaultTabButton.getAttribute('onclick').match(/'([^']+)'/);
                     if (tabIdMatch) {
                         showAdminSection(tabIdMatch[1], defaultTabButton);
                     }
                 }
            }
        }
        
        document.getElementById('shortlinks-section').style.display = 'none';
        document.getElementById('withdraw-section').style.display = 'none';
        document.getElementById('admin-section').style.display = 'none';
        document.getElementById('dashboard-section').style.display = 'block'; 
        
    </script>
</body>
</html>
